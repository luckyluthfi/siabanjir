/* ESP32 Flood Monitor - Final
   - Float sensors primary (NO): FLOAT1=13, FLOAT2=12, FLOAT3=14
   - Ultrasonic A02YYUW on UART2 (RX=16, TX=17)
   - LEDs: HIJAU=0, BIRU=2, MERAH=4
   - Relay sirine: RELAY=5
   - Sirine hanya untuk BAHAYA:
       BAHAYA: ON 10s, OFF 1s Ã— 10 kali, lalu berhenti total
*/

#include <Arduino.h>
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <HTTPClient.h>
#include <HardwareSerial.h>
#include <time.h>

// pins
#define PIN_RX 16
#define PIN_TX 17

#define LED_HIJAU 0
#define LED_BIRU  2
#define LED_MERAH 4
#define RELAY     5

#define FLOAT1 13  // bottom / AMAN (NO)
#define FLOAT2 12  // middle / SIAGA (NO)
#define FLOAT3 14  // top / BAHAYA (NO)

HardwareSerial Ultrasonic_Sensor(2);

// wifi & server
const char* SSID     = "P******";
const char* PASSWORD = "******8";

String BOT_TOKEN = "**********:A*******9PHxI**********ND8pydaXasBHQ";
String CHAT_ID   = "**********";
String serverURL = "http://1**.16*.1.1**/web_name/inserthilir.php";

// intervals
const unsigned long UPLOAD_INTERVAL_MS = 2000UL;
const unsigned long FLOAT_DEBOUNCE_MS  = 200UL;
const unsigned long WIFI_RECONNECT_MS  = 10000UL;
const unsigned long HTTP_TIMEOUT_MS    = 7000UL;

// globals
int distance = 9999;
unsigned char data_buffer[4];
unsigned char CS;

String lastStatus = "";
unsigned long lastSend = 0;
unsigned long lastWifiCheck = 0;

// float debounce
int floatStable1 = HIGH, floatStable2 = HIGH, floatStable3 = HIGH;
int floatLastRaw1 = HIGH, floatLastRaw2 = HIGH, floatLastRaw3 = HIGH;
unsigned long floatLastChange1 = 0, floatLastChange2 = 0, floatLastChange3 = 0;

// Siren variables
bool sirenRunning = false;
int sirenCount = 0;
bool sirenOn = false;
unsigned long sirenLastMillis = 0;


// ========================== NTP ==============================
void initTime() {
  configTime(25200, 0, "pool.ntp.org", "time.google.com");
  struct tm ti;
  unsigned long start = millis();
  while (!getLocalTime(&ti) && millis() - start < 8000) {
    delay(200);
  }
}

String getTimestamp() {
  struct tm ti;
  if (!getLocalTime(&ti)) return "1970-01-01 00:00:00";
  char buf[25];
  strftime(buf, sizeof(buf), "%Y-%m-%d %H:%M:%S", &ti);
  return String(buf);
}

// ========================== WiFi ==============================
void ensureWiFiConnected() {
  if (WiFi.status() == WL_CONNECTED) return;
  unsigned long now = millis();
  if (now - lastWifiCheck < WIFI_RECONNECT_MS) return;
  lastWifiCheck = now;

  Serial.println("WiFi reconnecting...");
  WiFi.disconnect(true);
  WiFi.begin(SSID, PASSWORD);

  unsigned long start = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - start < 8000) {
    delay(200);
    Serial.print(".");
  }

  if (WiFi.status() == WL_CONNECTED)
    Serial.println("\nWiFi OK: " + WiFi.localIP().toString());
  else
    Serial.println("\nWiFi FAIL");
}

// ========================== Telegram ==============================
void sendTelegramMessage(const String &msg) {
  if (WiFi.status() != WL_CONNECTED) return;

  WiFiClientSecure client;
  client.setInsecure();
  HTTPClient https;

  https.begin(client, "https://api.telegram.org/bot" + BOT_TOKEN + "/sendMessage");
  https.addHeader("Content-Type", "application/x-www-form-urlencoded");

  String body = "chat_id=" + CHAT_ID + "&text=" + msg;
  https.POST(body);
  https.end();
}

// ========================== HTTP Upload ==============================
bool uploadToServer(int dist, const String &status, const String &timestamp) {
  ensureWiFiConnected();
  if (WiFi.status() != WL_CONNECTED) return false;

  HTTPClient http;
  http.begin(serverURL);
  http.addHeader("Content-Type", "application/json");
  http.setTimeout(HTTP_TIMEOUT_MS);

  String json = "{\"distance\":" + String(dist) +
                ",\"status\":\"" + status +
                "\",\"timestamp\":\"" + timestamp + "\"}";

  int code = http.POST(json);
  http.end();
  return (code >= 200 && code < 300);
}

// ========================== Ultrasonic ==============================
void baca_kethilir() {
  if (Ultrasonic_Sensor.available() > 0) {
    delay(4);

    if (Ultrasonic_Sensor.read() == 0xff) {
      data_buffer[0] = 0xff;
      for (int i = 1; i < 4; i++) {
        data_buffer[i] = Ultrasonic_Sensor.read();
      }

      CS = data_buffer[0] + data_buffer[1] + data_buffer[2];

      if (data_buffer[3] == CS) {
        distance = ((data_buffer[1] << 8) + data_buffer[2]) / 10;
      }
    }
  }
}

// ========================== Float Debounce ==============================
int readDebouncedFloats() {
  int r1 = digitalRead(FLOAT1);
  int r2 = digitalRead(FLOAT2);
  int r3 = digitalRead(FLOAT3);

  unsigned long now = millis();

  if (r1 != floatLastRaw1) { floatLastChange1 = now; floatLastRaw1 = r1; }
  else if (now - floatLastChange1 >= FLOAT_DEBOUNCE_MS) floatStable1 = floatLastRaw1;

  if (r2 != floatLastRaw2) { floatLastChange2 = now; floatLastRaw2 = r2; }
  else if (now - floatLastChange2 >= FLOAT_DEBOUNCE_MS) floatStable2 = floatLastRaw2;

  if (r3 != floatLastRaw3) { floatLastChange3 = now; floatLastRaw3 = r3; }
  else if (now - floatLastChange3 >= FLOAT_DEBOUNCE_MS) floatStable3 = floatLastRaw3;

  int f1 = (floatStable1 == LOW) ? 1 : 0;
  int f2 = (floatStable2 == LOW) ? 1 : 0;
  int f3 = (floatStable3 == LOW) ? 1 : 0;

  return (f1 << 0) | (f2 << 1) | (f3 << 2);
}

String evaluateStatusFromFloats(int bitmask) {
  if (bitmask & (1 << 2)) return "BAHAYA";
  if (bitmask & (1 << 1)) return "SIAGA";
  if (bitmask & (1 << 0)) return "AMAN";
  return "AMAN";
}

String evaluateStatusFromUltrasonic(int dist) {
  if (dist >= 0 && dist <= 99) return "BAHAYA";
  if (dist >= 100 && dist <= 199) return "SIAGA";
  if (dist >= 200 && dist <= 500) return "AMAN";
  return "TIDAK VALID";
}

String finalDecision(const String &floatStatus, const String &ultraStatus) {
  if (ultraStatus == "BAHAYA" && floatStatus != "BAHAYA") return "BAHAYA";
  if (ultraStatus == "SIAGA" && floatStatus == "AMAN") return "SIAGA";
  return floatStatus;
}

// ========================== NEW SIREN LOGIC ==============================
// BAHAYA only â†’ ON 10s, OFF 1s Ã— 10 kali
void handleSiren(const String &level) {
  unsigned long now = millis();

  // Semua status selain BAHAYA â†’ sirine mati
  if (level != "BAHAYA") {
    digitalWrite(RELAY, LOW);
    sirenRunning = false;
    sirenCount = 0;
    sirenOn = false;
    return;
  }

  if (!sirenRunning) {
    sirenRunning = true;
    sirenCount = 0;
    sirenOn = false;
    sirenLastMillis = millis();
  }

  if (sirenCount >= 10) {
    digitalWrite(RELAY, LOW);
    sirenRunning = false;
    return;
  }

  unsigned long onDur = 10000UL; // 10s
  unsigned long offDur = 1000UL; // 1s

  if (!sirenOn) {
    if (now - sirenLastMillis >= offDur) {
      digitalWrite(RELAY, HIGH);
      sirenOn = true;
      sirenLastMillis = now;
    }
  } else {
    if (now - sirenLastMillis >= onDur) {
      digitalWrite(RELAY, LOW);
      sirenOn = false;
      sirenLastMillis = now;
      sirenCount++;
    }
  }
}

// ========================== Telegram ==============================
void sendTelegramIfChanged(const String &status, int dist) {
  static String lastSent = "";
  if (status != lastSent) {
    sendTelegramMessage("ðŸ”” STATUS: " + status + "\nDistance: " + String(dist) +
                        " cm\nTime: " + getTimestamp());
    lastSent = status;
  }
}

// ========================== SETUP ==============================
void setup() {
  Serial.begin(115200);

  pinMode(LED_HIJAU, OUTPUT);
  pinMode(LED_BIRU, OUTPUT);
  pinMode(LED_MERAH, OUTPUT);
  pinMode(RELAY, OUTPUT);

  pinMode(FLOAT1, INPUT_PULLUP);
  pinMode(FLOAT2, INPUT_PULLUP);
  pinMode(FLOAT3, INPUT_PULLUP);

  WiFi.begin(SSID, PASSWORD);
  initTime();
  Ultrasonic_Sensor.begin(9600, SERIAL_8N1, PIN_RX, PIN_TX);

  floatStable1 = digitalRead(FLOAT1);
  floatStable2 = digitalRead(FLOAT2);
  floatStable3 = digitalRead(FLOAT3);

  lastSend = millis();

  if (WiFi.status() == WL_CONNECTED) {
    sendTelegramMessage("ðŸš€ ESP32 Hilir - System Started (" + WiFi.localIP().toString() + ")");
  }
}

// ========================== LOOP ==============================
void loop() {
  ensureWiFiConnected();

  baca_kethilir();
  int floatMask = readDebouncedFloats();

  String floatStatus = evaluateStatusFromFloats(floatMask);
  String ultraStatus = evaluateStatusFromUltrasonic(distance);
  String finalStatus = finalDecision(floatStatus, ultraStatus);

  // LED status
  digitalWrite(LED_MERAH, finalStatus == "BAHAYA");
  digitalWrite(LED_BIRU,  finalStatus == "SIAGA");
  digitalWrite(LED_HIJAU, finalStatus == "AMAN");

  // Sirine (non-blocking)
  handleSiren(finalStatus);

  // Debug
  Serial.printf("Dist:%d | Float:%s | Ultra:%s | Final:%s\n",
                distance, floatStatus.c_str(), ultraStatus.c_str(), finalStatus.c_str());

  // Telegram saat berubah
  sendTelegramIfChanged(finalStatus, distance);

  // Upload saat berubah
  if (finalStatus != lastStatus) {
    uploadToServer(distance, finalStatus, getTimestamp());
    lastStatus = finalStatus;
    lastSend = millis();
  }

  // Upload berkala
  if (millis() - lastSend >= UPLOAD_INTERVAL_MS) {
    uploadToServer(distance, finalStatus, getTimestamp());
    lastSend = millis();
  }

  delay(20);
}
